name: Lint and Test

on: [push, pull_request]

jobs:
  verify:
    name: Run Lint and Tests
    runs-on: ubuntu-latest
#    services:
#      fhir-validator-service:
#        image: infernocommunity/fhir-validator-service
#        env:
#          DISABLE_TX: 'false'
#        volumes:
#          - /igs:/home/igs  
#        ports:
#          - 4567:4567
      # matchbox:
      #   image: eu.gcr.io/fhir-ch/matchbox:v141
      #   env:
      #     hapi.fhir.implementationguides.0.name: hl7.fhir.uv.sdc
      #     hapi.fhir.implementationguides.0.version: 2.7.0
      #     hapi.fhir.implementationguides.1.name: ihe.mhd.fhir
      #     hapi.fhir.implementationguides.1.version: 4.0.1 
      #     hapi.fhir.implementationguides.2.url: https://worldhealthorganization.github.io/ddcc/refs/heads/ddcc-tr/package.tgz
      #     hapi.fhir.implementationguides.2.name: fhir.who.ddcc-vs
      #     hapi.fhir.implementationguides.2.version: 0.3.1
      #     hapi.fhir.implementationguides.3.name: hl7.fhir.uv.ips
      #     hapi.fhir.implementationguides.3.version: 1.0.0  
      #   ports:
      #     - 8080:8080 
     
    steps:
    - uses: actions/checkout@v1

    - run: docker-compose up -d validator_service

    - uses: actions/setup-node@v1
      with:
        node-version: '14.x'
    
    - run: npm install

    - run: npm run lint

    - run: npm run test
      env:
        CI: true

    - name: Dump docker logs on failure
      if: failure()
      run: docker logs fhir-validator-service
